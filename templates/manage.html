<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debian Updater - Manage Servers</title>
    <style>
        :root {
            --bg: #0e151b;
            --bg-soft: #131c24;
            --card: #16212b;
            --card-2: #0f1820;
            --text: #f2f5f7;
            --muted: #b8c2cc;
            --accent: #38bdf8;
            --accent-2: #22d3ee;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Bahnschrift", "Segoe UI Variable", "Segoe UI", sans-serif;
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            background:
                radial-gradient(800px 400px at 10% 0%, rgba(56, 189, 248, 0.18), transparent 60%),
                radial-gradient(700px 500px at 90% 10%, rgba(34, 211, 238, 0.18), transparent 60%),
                linear-gradient(160deg, #0b1116 0%, #0e151b 60%, #0b141c 100%);
        }

        .page {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 36px clamp(12px, 2.2vw, 34px) 64px;
        }

        .hero {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.18), rgba(34, 211, 238, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 28px 28px 24px;
            border-radius: 18px;
            box-shadow: var(--shadow);
            margin-bottom: 28px;
            position: relative;
            overflow: hidden;
        }

        .hero::after {
            content: "";
            position: absolute;
            right: -120px;
            top: -160px;
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(56, 189, 248, 0.35), transparent 70%);
            filter: blur(1px);
        }

        h1, h2 {
            margin: 0 0 12px;
            letter-spacing: 0.4px;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
        }

        h2 {
            font-size: 20px;
            color: var(--muted);
            font-weight: 600;
        }

        .subtle {
            color: var(--muted);
            font-size: 14px;
            margin: 0 0 16px;
        }

        .card {
            background: linear-gradient(180deg, rgba(22, 33, 43, 0.95), rgba(15, 24, 32, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }

        .add-server-form {
            max-width: 900px;
            grid-template-columns: repeat(4, minmax(180px, 1fr));
        }

        .form-note {
            grid-column: 1 / -1;
        }

        .checkbox-inline {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            line-height: 1.3;
        }

        .add-server-form .checkbox-inline {
            grid-column: 1 / -1;
            margin: 0 0 4px;
            font-size: 14px;
            color: var(--muted);
        }

        .field .checkbox-inline {
            text-transform: none;
            letter-spacing: 0;
            font-size: 14px;
        }

        .checkbox-inline input[type="checkbox"] {
            width: auto;
            padding: 0;
            margin: 0;
            border: 0;
            border-radius: 0;
            background: transparent;
            box-shadow: none;
            accent-color: #22d3ee;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(4, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 6px;
            align-items: center;
        }

        .form-actions .action-left {
            grid-column: 1 / 2;
        }

        .form-actions .action-right {
            grid-column: 4 / 5;
        }

        .form-actions button,
        .form-actions .file-btn {
            width: 100%;
        }

        input {
            background: rgba(8, 13, 18, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .add-server-form input,
        .add-server-form .file-btn,
        .add-server-form button {
            width: 100%;
        }

        .file-input {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .file-btn {
            background: linear-gradient(135deg, #38bdf8, #22d3ee);
            border: none;
            color: #051019;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            box-shadow: 0 12px 24px rgba(34, 211, 238, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .file-btn:hover { transform: translateY(-1px); }

        input:focus {
            border-color: rgba(56, 189, 248, 0.8);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }

        button {
            background: linear-gradient(135deg, #38bdf8, #22d3ee);
            border: none;
            color: #051019;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            box-shadow: 0 12px 24px rgba(34, 211, 238, 0.2);
        }

        button:hover, .btn-link:hover { transform: translateY(-1px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.18);
            color: var(--text);
            box-shadow: none;
        }

        .btn-link {
            background: linear-gradient(135deg, #38bdf8, #22d3ee);
            border: none;
            color: #051019;
            box-shadow: 0 12px 24px rgba(34, 211, 238, 0.2);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f87171, #fb7185);
            color: #1a0a0a;
            box-shadow: 0 12px 24px rgba(248, 113, 113, 0.25);
        }

        .btn-success {
            background: linear-gradient(135deg, #34d399, #22c55e);
            color: #061a12;
            box-shadow: 0 12px 24px rgba(34, 197, 94, 0.25);
        }

        .nav {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .key-actions {
            margin-bottom: 18px;
        }

        .section-sep {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.12);
            margin: 18px 0;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 12px 0;
        }

        .controls input,
        .controls select {
            min-width: 160px;
        }

        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
        }

        .table-wrap { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 520px;
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            vertical-align: top;
        }

        th:last-child,
        td:last-child {
            border-right: none;
        }

        th {
            font-size: 13px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable::after {
            content: " â‡…";
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .actions-col {
            width: 180px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 12px;
            text-transform: capitalize;
            background: rgba(255, 255, 255, 0.08);
        }

        .status-success { color: #34d399; }
        .status-failure { color: #f87171; }
        .status-started { color: #38bdf8; }
        .status-ignored { color: #fbbf24; }

        .audit-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }

        .audit-controls input,
        .audit-controls select {
            min-width: 180px;
        }

        .audit-pagination {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            margin-right: 6px;
        }

        .pill-success {
            color: #062016;
            background: rgba(52, 211, 153, 0.9);
        }

        .pill-muted {
            color: var(--muted);
            background: rgba(255, 255, 255, 0.04);
        }

        .group-row td {
            background: rgba(255, 255, 255, 0.05);
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        tr {
            transition: background 0.2s ease;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        td button { display: block; margin: 6px 0; width: 100%; }

        .inline-btn {
            width: auto;
            display: inline-flex;
        }

        .key-section {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 255, 255, 0.18);
        }

        .key-section .file-btn {
            width: 100%;
            display: block;
        }

        #edit-modal .key-section .file-btn,
        .key-section .file-btn.small {
            width: auto !important;
            display: inline-flex;
            align-self: flex-start;
        }

        .fade-in {
            animation: fadeIn 0.7s ease forwards;
            opacity: 0;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(6, 10, 14, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            padding: 18px;
            width: min(520px, 92vw);
            box-shadow: var(--shadow);
        }

        .modal h3 {
            margin: 0 0 10px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .modal-grid .full-width {
            grid-column: 1 / -1;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
            from { opacity: 0; transform: translateY(8px); }
        }

        @media (max-width: 720px) {
            .page { padding: 22px 12px 56px; }
            .hero { padding: 22px; }
            h1 { font-size: 26px; }
            table { min-width: 460px; }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="hero fade-in">
            <h1>Manage Servers</h1>
            <p class="subtle">Add, edit, and remove servers used by the updater.</p>
            <div class="nav">
                <a class="btn-link" href="/">View Status</a>
                <a class="btn-link" href="/observability">Observability</a>
            </div>
        </header>

        <section class="card fade-in">
            <h2>Server Management</h2>
            <p class="subtle">Upload a global SSH key to use for all servers without a per-server key.</p>
            <div class="nav key-actions">
                <input class="file-input" type="file" id="global-key-file" accept=".pem,.key,.rsa,.ed25519">
                <label class="file-btn" for="global-key-file">Click to upload key</label>
                <button class="btn-success" onclick="uploadGlobalKey()">Upload Global Key</button>
                <button class="btn-danger" onclick="clearGlobalKey()">Clear Global Key</button>
            </div>
            <div id="global-key-status" class="subtle"></div>
            <hr class="section-sep">
            <form id="add-server-form" class="add-server-form">
                <span class="subtle form-note">Auth is password or SSH key (key takes priority). Leave one empty.</span>
                <input type="text" id="name" placeholder="Name" required>
                <input type="text" id="host" placeholder="Host" required>
                <input type="number" id="port" placeholder="SSH Port" min="1" max="65535">
                <input type="text" id="user" placeholder="User" required>
                <input type="password" id="pass" placeholder="Password (optional)">
                <input type="text" id="tags" placeholder="Tags (comma-separated)">
                <label class="checkbox-inline"><input type="checkbox" id="trust-host-key" checked> Trust SSH host key now (confirm fingerprint)</label>
                <div class="form-actions">
                    <button class="btn-success action-left" type="submit">Add Server</button>
                    <div class="action-right">
                        <input class="file-input" type="file" id="key_file" accept=".pem,.key,.rsa,.ed25519">
                        <label class="file-btn" for="key_file">Click to upload key</label>
                    </div>
                </div>
            </form>

            <div class="controls">
                <input type="text" id="search" placeholder="Search name/host/user/tags">
                <input type="text" id="tag-filter" placeholder="Filter tag">
                <select id="auth-filter">
                    <option value="">All auth</option>
                    <option value="password">Has password</option>
                    <option value="key">Has key</option>
                </select>
                <select id="group-by">
                    <option value="">No grouping</option>
                    <option value="tag">Group by tag</option>
                    <option value="auth">Group by auth</option>
                </select>
                <select id="page-size">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>

            <div class="table-wrap">
                <table id="manage-servers-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort-key="name">Name</th>
                            <th class="sortable" data-sort-key="host">Host</th>
                            <th class="sortable" data-sort-key="user">User</th>
                            <th class="sortable" data-sort-key="tags">Tags</th>
                            <th>Auth</th>
                            <th class="actions-col">Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="btn-ghost inline-btn" id="prev-page">Prev</button>
                <span id="page-info" class="subtle"></span>
                <button class="btn-ghost inline-btn" id="next-page">Next</button>
            </div>
        </section>

        <section class="card fade-in" style="margin-top: 20px;">
            <h2>Activity History</h2>
            <p class="subtle">Tracks who did what and when. Entries older than 90 days are auto-pruned.</p>
            <div class="audit-controls">
                <input type="text" id="audit-target-filter" placeholder="Target name">
                <input type="text" id="audit-action-filter" placeholder="Action (e.g. server.create)">
                <select id="audit-status-filter">
                    <option value="">All statuses</option>
                    <option value="success">Success</option>
                    <option value="failure">Failure</option>
                    <option value="started">Started</option>
                    <option value="ignored">Ignored</option>
                </select>
                <button class="btn-ghost inline-btn" id="audit-refresh">Refresh</button>
                <button class="btn-ghost inline-btn" id="audit-prune">Prune (90d)</button>
            </div>
            <div class="table-wrap">
                <table id="audit-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Actor</th>
                            <th>Action</th>
                            <th>Target</th>
                            <th>Status</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="audit-pagination">
                <button class="btn-ghost inline-btn" id="audit-prev-page">Prev</button>
                <span id="audit-page-info" class="subtle"></span>
                <button class="btn-ghost inline-btn" id="audit-next-page">Next</button>
            </div>
        </section>
    </div>

    <div class="modal-backdrop" id="edit-modal">
        <div class="modal">
            <h3>Edit Server</h3>
            <div class="modal-grid">
                <div class="field">
                    <label for="edit-name">Name</label>
                    <input type="text" id="edit-name" placeholder="Name" required>
                </div>
                <div class="field">
                    <label for="edit-host">Host</label>
                    <input type="text" id="edit-host" placeholder="Host" required>
                </div>
                <div class="field">
                    <label for="edit-port">SSH Port</label>
                    <input type="number" id="edit-port" placeholder="SSH Port" min="1" max="65535">
                </div>
                <div class="field">
                    <label for="edit-user">User</label>
                    <input type="text" id="edit-user" placeholder="User" required>
                </div>
                <div class="field">
                    <label for="edit-tags">Tags</label>
                    <input type="text" id="edit-tags" placeholder="Tags (comma-separated)">
                </div>
                <div class="field">
                    <label for="edit-pass">Password</label>
                    <input type="password" id="edit-pass" placeholder="New password">
                </div>
                <div class="field full-width">
                    <label class="checkbox-inline"><input type="checkbox" id="edit-trust-host-key" checked> Trust SSH host key now (confirm fingerprint)</label>
                </div>
                <div class="field">
                    <label>&nbsp;</label>
                    <button class="btn-danger" id="edit-clear-password">Clear Password</button>
                </div>
                <div class="key-section full-width">
                    <div class="subtle">SSH key management</div>
                    <input class="file-input" type="file" id="edit-key" accept=".pem,.key,.rsa,.ed25519">
                    <label class="file-btn small" for="edit-key">Click to upload key</label>
                    <button class="btn-success" id="edit-upload-key">Upload Key</button>
                    <button class="btn-danger" id="edit-clear-key">Clear Key</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-ghost inline-btn" id="edit-cancel">Cancel</button>
                <button class="btn-success inline-btn" id="edit-save">Save</button>
            </div>
        </div>
    </div>

    <script>
        let serverCache = {};
        let sortKey = "name";
        let sortDir = "asc";
        let manageServers = [];
        let page = 1;
        let editingServerName = null;
        let auditEvents = [];
        let auditPage = 1;
        let auditPageSize = 20;
        let auditTotal = 0;

        function escapeHtml(value) {
            return String(value ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function escapeJsSingleQuoted(value) {
            return String(value ?? "")
                .replace(/\\/g, "\\\\")
                .replace(/'/g, "\\'")
                .replace(/\r/g, "\\r")
                .replace(/\n/g, "\\n")
                .replace(/\u2028/g, "\\u2028")
                .replace(/\u2029/g, "\\u2029");
        }

        function normalizePort(value, fallback = 22) {
            const parsed = Number.parseInt(value, 10);
            if (!Number.isFinite(parsed) || parsed <= 0 || parsed > 65535) return fallback;
            return parsed;
        }

        async function parseErrorResponse(res, fallbackMessage) {
            const data = await res.json().catch(() => ({}));
            return data.error || fallbackMessage;
        }

        async function scanHostKey(host, port) {
            const res = await fetch('/api/hostkeys/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host, port })
            });
            if (!res.ok) {
                throw new Error(await parseErrorResponse(res, 'Failed to scan host key.'));
            }
            return res.json();
        }

        async function trustHostKey(host, port, fingerprint) {
            const res = await fetch('/api/hostkeys/trust', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host, port, fingerprint_sha256: fingerprint })
            });
            if (!res.ok) {
                throw new Error(await parseErrorResponse(res, 'Failed to trust host key.'));
            }
            return res.json();
        }

        async function trustHostKeyFlow(host, port) {
            const scanned = await scanHostKey(host, port);
            const confirmed = confirm(
                `Verify SSH host key before trusting:\n\n` +
                `Host: ${scanned.host}\n` +
                `Port: ${scanned.port}\n` +
                `Algorithm: ${scanned.algorithm}\n` +
                `Fingerprint: ${scanned.fingerprint_sha256}\n\n` +
                `Add this key to known_hosts?`
            );
            if (!confirmed) {
                throw new Error('Host key trust cancelled.');
            }
            await trustHostKey(scanned.host, scanned.port, scanned.fingerprint_sha256);
        }

        function saveWindowScroll() {
            return { x: window.scrollX, y: window.scrollY };
        }

        function restoreWindowScroll(pos) {
            if (!pos) return;
            window.scrollTo(pos.x, pos.y);
        }

        async function fetchManageServers() {
            const pageScroll = saveWindowScroll();
            const response = await fetch('/api/servers');
            manageServers = await response.json();
            const tbody = document.querySelector('#manage-servers-table tbody');
            tbody.innerHTML = '';
            renderTable();
            requestAnimationFrame(() => restoreWindowScroll(pageScroll));
        }

        function sortServers(servers) {
            const dir = sortDir === "asc" ? 1 : -1;
            return servers.slice().sort((a, b) => {
                const aVal = (sortKey === "tags" ? (a.tags || []).join(",") : (a[sortKey] || "")).toString().toLowerCase();
                const bVal = (sortKey === "tags" ? (b.tags || []).join(",") : (b[sortKey] || "")).toString().toLowerCase();
                if (aVal < bVal) return -1 * dir;
                if (aVal > bVal) return 1 * dir;
                return 0;
            });
        }

        function applyFilters(servers) {
            const search = document.getElementById('search').value.trim().toLowerCase();
            const tagFilter = document.getElementById('tag-filter').value.trim().toLowerCase();
            const authFilter = document.getElementById('auth-filter').value;
            return servers.filter(server => {
                if (authFilter === "password" && !server.has_password) return false;
                if (authFilter === "key" && !server.has_key) return false;
                if (tagFilter) {
                    const tags = (server.tags || []).join(" ").toLowerCase();
                    if (!tags.includes(tagFilter)) return false;
                }
                if (!search) return true;
                const haystack = [
                    server.name,
                    server.host,
                    server.user,
                    (server.tags || []).join(" ")
                ].join(" ").toLowerCase();
                return haystack.includes(search);
            });
        }

        function paginate(servers) {
            const size = parseInt(document.getElementById('page-size').value, 10);
            const totalPages = Math.max(1, Math.ceil(servers.length / size));
            page = Math.min(page, totalPages);
            const start = (page - 1) * size;
            const end = start + size;
            document.getElementById('page-info').textContent = `Page ${page} of ${totalPages} (${servers.length} hosts)`;
            return servers.slice(start, end);
        }

        function groupServers(servers) {
            const groupBy = document.getElementById('group-by').value;
            if (!groupBy) return [{ key: "", items: servers }];
            const groups = new Map();
            if (groupBy === "tag") {
                servers.forEach(server => {
                    const tags = server.tags && server.tags.length ? server.tags : ["untagged"];
                    tags.forEach(tag => {
                        if (!groups.has(tag)) groups.set(tag, []);
                        groups.get(tag).push(server);
                    });
                });
            } else if (groupBy === "auth") {
                servers.forEach(server => {
                    const key = server.has_key ? "key" : "no key";
                    const pw = server.has_password ? "password" : "no password";
                    const group = `${key} / ${pw}`;
                    if (!groups.has(group)) groups.set(group, []);
                    groups.get(group).push(server);
                });
            }
            return Array.from(groups.entries()).map(([key, items]) => ({ key, items }));
        }

        function renderTable() {
            const tbody = document.querySelector('#manage-servers-table tbody');
            tbody.innerHTML = '';
            serverCache = {};
            let servers = applyFilters(manageServers);
            servers = sortServers(servers);
            const paged = paginate(servers);
            const groups = groupServers(paged);
            groups.forEach(group => {
                if (group.key) {
                    const groupRow = document.createElement('tr');
                    groupRow.className = 'group-row';
                    groupRow.innerHTML = `<td colspan="6">${escapeHtml(group.key)}</td>`;
                    tbody.appendChild(groupRow);
                }
                group.items.forEach(server => {
                    serverCache[server.name] = server;
                    const row = document.createElement('tr');
                    row.dataset.name = server.name;
                    const safeNameJs = escapeJsSingleQuoted(server.name);
                    const safeName = escapeHtml(server.name);
                    const safeHost = escapeHtml(server.host);
                    const safeUser = escapeHtml(server.user);
                    row.innerHTML = `
                        <td>${safeName}</td>
                        <td>${safeHost}</td>
                        <td>${safeUser}</td>
                        <td>${renderTags(server.tags)}</td>
                        <td>${renderAuth(server)}</td>
                        <td>
                            <button class="btn-ghost" onclick="editServer('${safeNameJs}')">Edit</button>
                            <button class="btn-danger" onclick="deleteServer('${safeNameJs}')">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        document.querySelectorAll('#manage-servers-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sortKey;
                if (sortKey === key) {
                    sortDir = sortDir === "asc" ? "desc" : "asc";
                } else {
                    sortKey = key;
                    sortDir = "asc";
                }
                renderTable();
            });
        });

        document.getElementById('search').addEventListener('input', () => { page = 1; renderTable(); });
        document.getElementById('tag-filter').addEventListener('input', () => { page = 1; renderTable(); });
        document.getElementById('auth-filter').addEventListener('change', () => { page = 1; renderTable(); });
        document.getElementById('group-by').addEventListener('change', () => { page = 1; renderTable(); });
        document.getElementById('page-size').addEventListener('change', () => { page = 1; renderTable(); });

        document.getElementById('prev-page').addEventListener('click', () => {
            page = Math.max(1, page - 1);
            renderTable();
        });
        document.getElementById('next-page').addEventListener('click', () => {
            page += 1;
            renderTable();
        });
        document.getElementById('audit-prev-page').addEventListener('click', async () => {
            auditPage = Math.max(1, auditPage - 1);
            await fetchAuditEvents();
        });
        document.getElementById('audit-next-page').addEventListener('click', async () => {
            auditPage += 1;
            await fetchAuditEvents();
        });
        document.getElementById('audit-target-filter').addEventListener('input', async () => {
            auditPage = 1;
            await fetchAuditEvents();
        });
        document.getElementById('audit-action-filter').addEventListener('input', async () => {
            auditPage = 1;
            await fetchAuditEvents();
        });
        document.getElementById('audit-status-filter').addEventListener('change', async () => {
            auditPage = 1;
            await fetchAuditEvents();
        });
        document.getElementById('audit-refresh').addEventListener('click', fetchAuditEvents);
        document.getElementById('audit-prune').addEventListener('click', async () => {
            const res = await fetch('/api/audit-events/prune', { method: 'POST' });
            if (!res.ok) {
                alert(await parseErrorResponse(res, 'Failed to prune audit events.'));
                return;
            }
            await fetchAuditEvents();
        });

        function renderAuth(server) {
            const bits = [];
            if (server.has_password) {
                bits.push('<span class="pill pill-success">Password</span>');
            } else {
                bits.push('<span class="pill pill-muted">No Password</span>');
            }
            if (server.has_key) {
                bits.push('<span class="pill pill-success">Key</span>');
            } else {
                bits.push('<span class="pill pill-muted">No Key</span>');
            }
            return bits.join(' ');
        }

        function renderTags(tags) {
            if (!tags || tags.length === 0) {
                return '<span class="pill pill-muted">None</span>';
            }
            return tags.map(tag => `<span class="pill">${escapeHtml(tag)}</span>`).join(' ');
        }

        function renderAuditTable() {
            const tbody = document.querySelector('#audit-table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!auditEvents.length) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" class="subtle">No activity yet.</td>';
                tbody.appendChild(row);
            } else {
                auditEvents.forEach(evt => {
                    const row = document.createElement('tr');
                    const status = escapeHtml(evt.status || 'unknown');
                    const statusClass = `status-${String(evt.status || '').toLowerCase()}`;
                    row.innerHTML = `
                        <td>${escapeHtml(evt.created_at || '')}</td>
                        <td>${escapeHtml(evt.actor || '')}</td>
                        <td>${escapeHtml(evt.action || '')}</td>
                        <td>${escapeHtml(evt.target_type || '')}: ${escapeHtml(evt.target_name || '')}</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td>${escapeHtml(evt.message || '')}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            const totalPages = Math.max(1, Math.ceil(auditTotal / auditPageSize));
            const currentPage = Math.min(auditPage, totalPages);
            document.getElementById('audit-page-info').textContent = `Page ${currentPage} of ${totalPages} (${auditTotal} events)`;
        }

        async function fetchAuditEvents() {
            const params = new URLSearchParams({
                page: String(auditPage),
                page_size: String(auditPageSize)
            });
            const targetName = document.getElementById('audit-target-filter').value.trim();
            const action = document.getElementById('audit-action-filter').value.trim();
            const status = document.getElementById('audit-status-filter').value;
            if (targetName) params.set('target_name', targetName);
            if (action) params.set('action', action);
            if (status) params.set('status', status);
            const res = await fetch(`/api/audit-events?${params.toString()}`);
            if (!res.ok) {
                const msg = await parseErrorResponse(res, 'Failed to load audit events.');
                alert(msg);
                return;
            }
            const data = await res.json();
            auditEvents = data.items || [];
            auditTotal = Number(data.total || 0);
            const totalPages = Math.max(1, Math.ceil(auditTotal / auditPageSize));
            if (auditPage > totalPages) {
                auditPage = totalPages;
                await fetchAuditEvents();
                return;
            }
            renderAuditTable();
        }

        document.getElementById('add-server-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const host = document.getElementById('host').value;
            const portValue = document.getElementById('port').value;
            const port = portValue ? parseInt(portValue, 10) : 0;
            const user = document.getElementById('user').value;
            const pass = document.getElementById('pass').value;
            const tagsRaw = document.getElementById('tags').value;
            const tags = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
            const keyFileInput = document.getElementById('key_file');
            const trustHostNow = document.getElementById('trust-host-key').checked;
            const trimmedName = name.trim();
            const createRes = await fetch('/api/servers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, host, port, user, pass, tags })
            });
            if (!createRes.ok) {
                alert(await parseErrorResponse(createRes, 'Failed to add server.'));
                return;
            }
            const created = await createRes.json().catch(() => ({
                name: trimmedName || name,
                host: host.trim(),
                port: normalizePort(port, 22)
            }));
            if (keyFileInput && keyFileInput.files && keyFileInput.files.length > 0) {
                const form = new FormData();
                form.append('key', keyFileInput.files[0]);
                const serverName = created.name || trimmedName || name;
                const res = await fetch(`/api/servers/${encodeURIComponent(serverName)}/key`, { method: 'POST', body: form });
                if (!res.ok) {
                    alert(await parseErrorResponse(res, 'Failed to upload key.'));
                }
            }
            if (trustHostNow) {
                try {
                    await trustHostKeyFlow(created.host || host.trim(), normalizePort(created.port, 22));
                } catch (err) {
                    alert(`Server added, but host key was not trusted: ${err.message || 'unknown error'}`);
                }
            }
            if (keyFileInput) {
                keyFileInput.value = '';
                updateFileLabel(keyFileInput);
            }
            fetchManageServers();
            e.target.reset();
            document.getElementById('trust-host-key').checked = true;
        });

        function updateFileLabel(input) {
            const label = document.querySelector(`label[for="${input.id}"]`);
            if (!label) return;
            const file = input.files && input.files[0];
            label.textContent = file ? file.name : 'Click to upload key';
        }

        document.addEventListener('change', (e) => {
            if (e.target && e.target.classList.contains('file-input')) {
                updateFileLabel(e.target);
            }
        });

        async function deleteServer(name) {
            if (confirm('Delete server?')) {
                await fetch(`/api/servers/${encodeURIComponent(name)}`, { method: 'DELETE' });
                fetchManageServers();
            }
        }

        function editServer(name) {
            const current = serverCache[name] || {};
            editingServerName = name;
            document.getElementById('edit-name').value = current.name || name;
            document.getElementById('edit-host').value = current.host || '';
            document.getElementById('edit-port').value = current.port || '';
            document.getElementById('edit-user').value = current.user || '';
            document.getElementById('edit-tags').value = (current.tags || []).join(', ');
            document.getElementById('edit-pass').value = '';
            document.getElementById('edit-trust-host-key').checked = true;
            const keyInput = document.getElementById('edit-key');
            if (keyInput) {
                keyInput.value = '';
                updateFileLabel(keyInput);
            }
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            editingServerName = null;
        }

        async function saveServerEdit() {
            if (!editingServerName) return;
            const newName = document.getElementById('edit-name').value.trim();
            const newHost = document.getElementById('edit-host').value.trim();
            const portValue = document.getElementById('edit-port').value;
            const newPort = portValue ? parseInt(portValue, 10) : 0;
            const newUser = document.getElementById('edit-user').value.trim();
            const tagsRaw = document.getElementById('edit-tags').value;
            const tags = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
            const newPass = document.getElementById('edit-pass').value;
            const trustHostNow = document.getElementById('edit-trust-host-key').checked;
            const current = serverCache[editingServerName] || {};
            const currentPort = normalizePort(current.port, 22);
            const targetPort = normalizePort(newPort || currentPort, 22);
            if (newName && newHost && newUser) {
                const res = await fetch(`/api/servers/${encodeURIComponent(editingServerName)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName, host: newHost, port: newPort, user: newUser, pass: newPass, tags })
                });
                if (!res.ok) {
                    alert(await parseErrorResponse(res, 'Failed to save server.'));
                    return;
                }
                if (trustHostNow) {
                    try {
                        await trustHostKeyFlow(newHost, targetPort);
                    } catch (err) {
                        alert(`Server saved, but host key was not trusted: ${err.message || 'unknown error'}`);
                    }
                }
                closeEditModal();
                fetchManageServers();
            }
        }

        async function uploadServerKey(name) {
            const input = document.getElementById('edit-key');
            if (!input || !input.files || input.files.length === 0) {
                alert('Select a private key file to upload.');
                return;
            }
            const form = new FormData();
            form.append('key', input.files[0]);
            const res = await fetch(`/api/servers/${encodeURIComponent(name)}/key`, { method: 'POST', body: form });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                alert(data.error || 'Failed to upload key.');
                return;
            }
            input.value = '';
            updateFileLabel(input);
            fetchManageServers();
        }

        async function clearServerKey(name) {
            const res = await fetch(`/api/servers/${encodeURIComponent(name)}/key`, { method: 'DELETE' });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                alert(data.error || 'Failed to clear key.');
                return;
            }
            fetchManageServers();
        }

        async function clearServerPassword(name) {
            const res = await fetch(`/api/servers/${encodeURIComponent(name)}/password`, { method: 'DELETE' });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                alert(data.error || 'Failed to clear password.');
                return;
            }
            fetchManageServers();
        }

        document.getElementById('edit-cancel').addEventListener('click', closeEditModal);
        document.getElementById('edit-save').addEventListener('click', saveServerEdit);
        document.getElementById('edit-upload-key').addEventListener('click', () => {
            if (editingServerName) {
                uploadServerKey(editingServerName);
            }
        });
        document.getElementById('edit-clear-key').addEventListener('click', () => {
            if (editingServerName) {
                clearServerKey(editingServerName);
            }
        });
        document.getElementById('edit-clear-password').addEventListener('click', () => {
            if (editingServerName) {
                clearServerPassword(editingServerName);
            }
        });

        async function uploadGlobalKey() {
            const input = document.getElementById('global-key-file');
            if (!input || !input.files || input.files.length === 0) {
                alert('Select a private key file to upload.');
                return;
            }
            const form = new FormData();
            form.append('key', input.files[0]);
            const res = await fetch('/api/keys/global', { method: 'POST', body: form });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                alert(data.error || 'Failed to upload global key.');
                return;
            }
            alert('Global key saved.');
            input.value = '';
            updateFileLabel(input);
            fetchGlobalKeyStatus();
        }

        async function clearGlobalKey() {
            const res = await fetch('/api/keys/global', { method: 'DELETE' });
            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                alert(data.error || 'Failed to clear global key.');
                return;
            }
            alert('Global key cleared.');
            fetchGlobalKeyStatus();
        }

        async function fetchGlobalKeyStatus() {
            const status = document.getElementById('global-key-status');
            if (!status) return;
            const res = await fetch('/api/keys/global');
            if (!res.ok) {
                status.textContent = 'Global key status: unknown';
                return;
            }
            const data = await res.json();
            status.textContent = data.has_key ? 'Global key: saved' : 'Global key: not set';
        }

        fetchManageServers();
        fetchGlobalKeyStatus();
        fetchAuditEvents();
        setInterval(fetchAuditEvents, 15000);
    </script>
</body>
</html>
