<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleLinuxUpdater - Dashboard</title>
    <style>
        :root {
            --bg: #0b1220;
            /* Intentional aliases: keep these tied to base tokens for consistency. */
            --bg-soft: var(--bg);
            --card: #111a2b;
            --card-2: var(--card);
            --card-alt: #17243b;
            --text: #e7edf7;
            --subtle: #94a3b8;
            --muted: var(--subtle);
            --accent: #38bdf8;
            --accent-2: var(--accent);
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --border: rgba(148, 163, 184, 0.2);
            --shadow: 0 10px 30px rgba(2, 8, 23, 0.35);
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(1200px 700px at 80% -20%, rgba(56, 189, 248, 0.18), transparent 60%), var(--bg);
        }

        .page {
            width: 100%;
            max-width: 1360px;
            margin: 0 auto;
            padding: 24px clamp(12px, 2.2vw, 34px) 64px;
        }

        .hero {
            background: linear-gradient(180deg, var(--card-alt), var(--card));
            border: 1px solid var(--border);
            padding: 28px 28px 24px;
            border-radius: 14px;
            box-shadow: var(--shadow);
            margin-bottom: 18px;
            position: relative;
            overflow: hidden;
            padding-left: 300px;
            min-height: 260px;
        }

        .hero::after {
            content: "";
            position: absolute;
            right: -120px;
            top: -160px;
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle at center, rgba(56, 189, 248, 0.22), transparent 70%);
            filter: blur(1px);
        }

        .hero-logo {
            width: 240px;
            height: 240px;
            object-fit: contain;
            position: absolute;
            left: 18px;
            top: 18px;
            pointer-events: none;
        }

        .version-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.04);
        }

        h1, h2 {
            margin: 0 0 12px;
            letter-spacing: 0.4px;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
        }

        h2 {
            font-size: 20px;
            color: var(--subtle);
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: linear-gradient(180deg, var(--card-alt), var(--card));
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .card + .card { margin-top: 20px; }

        .subtle {
            color: var(--muted);
            font-size: 14px;
            margin: 0 0 16px;
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }

        input {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus {
            border-color: rgba(56, 189, 248, 0.55);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }

        select {
            appearance: none;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.7);
            color: var(--text);
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 14px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            padding: 0;
            margin: 0;
            border: 0;
            border-radius: 0;
            background: transparent;
            box-shadow: none;
            accent-color: #22d3ee;
            vertical-align: middle;
            cursor: pointer;
            flex: 0 0 auto;
        }

        input[type="checkbox"]:focus {
            box-shadow: none;
        }

        button {
            appearance: none;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.7);
            color: var(--text);
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.2s ease, opacity 0.2s ease;
            box-shadow: none;
        }

        button:hover, .btn-link:hover {
            border-color: rgba(56, 189, 248, 0.55);
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            box-shadow: none;
        }

        .btn-link {
            appearance: none;
            border: 1px solid var(--border);
            background: rgba(15, 23, 42, 0.7);
            color: var(--text);
            box-shadow: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 9px 12px;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.2s ease, opacity 0.2s ease;
        }

        .btn-danger {
            background: rgba(127, 29, 29, 0.38);
            color: #fecaca;
            border-color: rgba(248, 113, 113, 0.5);
        }

        .btn-security {
            background: rgba(245, 158, 11, 0.18);
            color: #fde68a;
            border-color: rgba(245, 158, 11, 0.55);
        }

        .nav {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .controls input,
        .controls select {
            min-width: 160px;
        }

        .controls .spacer {
            flex: 1 1 auto;
        }

        .bulk-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }

        .bulk-actions label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .pagination {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
        }

        .group-row td {
            background: rgba(255, 255, 255, 0.05);
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .table-wrap { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 520px;
        }

        #servers-table {
            table-layout: fixed;
            width: max-content;
            min-width: 100%;
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .select-col {
            width: 44px;
            min-width: 44px;
            text-align: center;
            padding-left: 6px;
            padding-right: 6px;
        }

        th {
            font-size: 13px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable::after {
            content: " â‡…";
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        tr {
            transition: background 0.2s ease;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .row-hover {
            background: rgba(255, 255, 255, 0.03) !important;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
            background: rgba(255, 255, 255, 0.06);
            white-space: nowrap;
        }

        .status-idle { color: var(--success); }
        .status-updating { color: var(--warning); }
        .status-upgrading { color: var(--warning); }
        .status-pending_approval { color: var(--accent); }
        .status-approved { color: var(--accent-2); }
        .status-done { color: var(--accent); }
        .status-autoremove { color: var(--warning); }
        .status-sudoers { color: var(--accent-2); }
        .status-error { color: var(--danger); }
        .status-cancelled { color: var(--danger); }

        .logs-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .logs-actions {
            display: inline-flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .logs-hint {
            color: var(--muted);
            font-size: 11px;
            white-space: nowrap;
        }

        .pending-updates {
            margin-top: 8px;
            margin-bottom: 0;
            background: rgba(8, 12, 16, 0.55);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 10px;
        }

        .pending-updates h4 {
            margin: 0 0 6px;
            font-size: 13px;
            color: var(--muted);
            letter-spacing: 0.3px;
        }

        .pending-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
            align-items: center;
        }

        .pending-summary details {
            width: 100%;
        }

        .pending-summary summary {
            cursor: pointer;
            color: var(--accent);
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            margin-bottom: 6px;
        }

        .pending-summary summary:hover {
            text-decoration: underline;
        }

        .pending-note {
            margin: 0 0 8px;
            color: var(--muted);
            font-size: 12px;
        }

        .pending-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 0;
        }

        .pending-table th,
        .pending-table td {
            padding: 6px 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            font-size: 12px;
            vertical-align: top;
        }

        .pending-table th {
            color: var(--muted);
            font-weight: 600;
            text-transform: none;
            letter-spacing: 0;
        }

        .pending-table tr:last-child td {
            border-bottom: none;
        }

        .pending-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .pending-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            font-size: 11px;
            line-height: 1.3;
            color: var(--text);
            background: rgba(255, 255, 255, 0.04);
        }

        .pending-badge-security {
            color: #1a0a0a;
            background: rgba(248, 113, 113, 0.95);
            border-color: rgba(248, 113, 113, 0.8);
            font-weight: 700;
        }

        .pending-badge-cve {
            color: #051019;
            background: rgba(56, 189, 248, 0.95);
            border-color: rgba(56, 189, 248, 0.8);
            font-weight: 700;
        }

        .logs {
            background: rgba(8, 12, 16, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 10px 12px;
            height: calc(100vh - 250px);
            min-height: 260px;
            overflow-y: auto;
            font-family: "Cascadia Mono", "Consolas", monospace;
            font-size: 12px;
            color: #d6dee6;
        }

        .log-line {
            white-space: pre-wrap;
            line-height: 1.5;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            padding: 2px 0;
        }

        .log-line:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .log-line:last-child {
            border-bottom: none;
        }

        .log-line-error { color: #fda4af; }
        .log-line-warning { color: #fde68a; }
        .log-line-success { color: #86efac; }
        .log-line-info { color: #93c5fd; }

        .name-col {
            width: 220px;
            min-width: 140px;
        }
        .name-cell {
            max-width: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .actions-col {
            width: 500px;
            min-width: 420px;
        }
        .status-col {
            width: 120px;
            min-width: 96px;
        }

        th.resizable {
            position: relative;
            padding-right: 16px;
        }

        .col-title {
            display: inline-block;
        }

        .col-resize-handle {
            position: absolute;
            right: -1px;
            top: 0;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            touch-action: none;
            z-index: 2;
        }

        .col-resize-handle::before {
            content: "";
            position: absolute;
            left: 3px;
            top: 28%;
            width: 2px;
            height: 44%;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.5);
            transition: background 0.2s ease, opacity 0.2s ease;
            opacity: 0;
        }

        th.resizable:hover .col-resize-handle::before {
            background: rgba(148, 163, 184, 0.75);
            opacity: 1;
        }

        th.resizable.resizing .col-resize-handle::before {
            background: rgba(56, 189, 248, 0.95);
            opacity: 1;
        }

        body.col-resizing,
        body.col-resizing * {
            cursor: col-resize !important;
            user-select: none !important;
        }

        #servers-table td button {
            display: block;
            margin: 0;
            width: 100%;
        }

        #servers-table td .inline-btn {
            width: auto;
            display: inline-flex;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 6px;
            align-items: stretch;
        }

        .actions-grid button {
            width: 100%;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 6px 8px;
            font-size: 12px;
        }

        .drawer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(6, 10, 14, 0.45);
            display: none;
            z-index: 900;
        }

        .drawer-backdrop.open {
            display: block;
        }

        .side-drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(680px, 92vw);
            transform: translateX(100%);
            transition: transform 0.2s ease;
            background: linear-gradient(180deg, rgba(22, 33, 43, 0.98), rgba(15, 24, 32, 0.98));
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: -20px 0 40px rgba(0, 0, 0, 0.35);
            z-index: 950;
            display: flex;
            flex-direction: column;
        }

        .side-drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            padding: 16px 16px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .drawer-title {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            word-break: break-word;
        }

        .drawer-tabs {
            display: flex;
            gap: 8px;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .drawer-tab {
            min-width: 120px;
        }

        .drawer-tab.active {
            background: linear-gradient(135deg, #38bdf8, #22d3ee);
            color: #051019;
        }

        .drawer-content {
            padding: 12px 16px 16px;
            overflow-y: auto;
            flex: 1 1 auto;
        }

        .drawer-approval-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .drawer-approval-actions.hidden {
            display: none;
        }

        .drawer-panel {
            display: none;
        }

        .drawer-panel.active {
            display: block;
        }

        .drawer-empty {
            margin: 0;
            color: var(--muted);
            font-size: 13px;
        }

        .fade-in {
            animation: fadeIn 0.7s ease forwards;
            opacity: 0;
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(6, 10, 14, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            padding: 18px;
            width: min(420px, 92vw);
            box-shadow: var(--shadow);
        }

        .modal h3 {
            margin: 0 0 10px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 12px;
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
            from { opacity: 0; transform: translateY(8px); }
        }

        @media (max-width: 720px) {
            .page { padding: 22px 12px 56px; }
            .hero { padding: 22px; }
            h1 { font-size: 26px; }
            table { min-width: 420px; }
            .name-cell {
                max-width: none;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
            }
            .side-drawer {
                width: 100vw;
            }
            .hero { padding-left: 22px; }
            .hero-logo { position: static; width: 220px; height: 220px; margin-bottom: 12px; }
        }
    </style>
</head>
<body>
    <div class="page">
        <header class="hero fade-in">
            <img class="hero-logo" src="/static/logo.png" alt="Linux updates logo">
            <h1>Automate Linux Server Updates</h1>
            <div class="version-pill">Version v0.1.5</div>
            <div class="nav">
                <a class="btn-link" href="/manage">Manage Servers</a>
                <a class="btn-link" href="/observability">Observability</a>
            </div>
        </header>

        <section class="card fade-in">
            <h2>Server Status</h2>
            <div class="controls">
                <input type="text" id="search" placeholder="Search name/host/user/tags">
                <select id="status-filter">
                    <option value="">All statuses</option>
                    <option value="idle">Idle</option>
                    <option value="updating">Updating</option>
                    <option value="pending_approval">Pending approval</option>
                    <option value="upgrading">Upgrading</option>
                    <option value="autoremove">Autoremove</option>
                    <option value="done">Done</option>
                    <option value="error">Error</option>
                </select>
                <select id="auth-filter">
                    <option value="">All auth</option>
                    <option value="password">Has password</option>
                    <option value="key">Has key</option>
                </select>
                <select id="group-by">
                    <option value="">No grouping</option>
                    <option value="status">Group by status</option>
                    <option value="tag">Group by tag</option>
                </select>
                <select id="page-size">
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
            <div class="bulk-actions">
                <label><input type="checkbox" id="select-all"> Select page</label>
                <button class="inline-btn" id="bulk-update">Bulk update</button>
                <button class="inline-btn" id="bulk-approve">Bulk approve</button>
                <button class="inline-btn" id="bulk-cancel">Bulk cancel</button>
                <button class="inline-btn" id="bulk-autoremove">Bulk apt autoremove</button>
            </div>
            <div class="table-wrap">
                <table id="servers-table">
                    <colgroup>
                        <col data-col-key="select" style="width: 44px;">
                        <col data-col-key="name" style="width: 220px;">
                        <col data-col-key="status" style="width: 120px;">
                        <col data-col-key="actions" style="width: 500px;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th class="select-col"></th>
                            <th class="sortable name-col resizable" data-sort-key="name">
                                <span class="col-title">Server</span>
                                <span class="col-resize-handle" data-col-key="name" aria-hidden="true"></span>
                            </th>
                            <th class="sortable status-col" data-sort-key="status">
                                <span class="col-title">Status</span>
                            </th>
                            <th class="actions-col resizable">
                                <span class="col-title">Actions</span>
                                <span class="col-resize-handle" data-col-key="actions" aria-hidden="true"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="btn-ghost inline-btn" id="prev-page">Prev</button>
                <span id="page-info" class="subtle"></span>
                <button class="btn-ghost inline-btn" id="next-page">Next</button>
            </div>
        </section>
    </div>

    <div class="drawer-backdrop" id="status-drawer-backdrop"></div>
    <aside class="side-drawer" id="status-drawer" aria-hidden="true">
        <div class="drawer-header">
            <div>
                <h3 class="drawer-title" id="status-drawer-title">Server details</h3>
                <div id="status-drawer-status"></div>
            </div>
            <button class="btn-ghost inline-btn" id="status-drawer-close">Close</button>
        </div>
        <div class="drawer-tabs">
            <button class="btn-ghost inline-btn drawer-tab" id="drawer-tab-logs">Logs</button>
            <button class="btn-ghost inline-btn drawer-tab" id="drawer-tab-pending">Pending updates</button>
        </div>
        <div class="drawer-approval-actions hidden" id="status-drawer-approval-actions">
            <button class="inline-btn" id="drawer-approve-all">Approve all (0)</button>
            <button class="btn-security inline-btn" id="drawer-approve-security">Approve security only (0)</button>
        </div>
        <div class="drawer-content">
            <section class="drawer-panel" id="drawer-panel-logs">
                <div class="logs-toolbar">
                    <span class="logs-hint" id="drawer-logs-hint">Live auto-scroll</span>
                    <div class="logs-actions">
                        <button class="btn-ghost inline-btn" id="drawer-copy-logs">Copy</button>
                        <button class="btn-ghost inline-btn" id="drawer-download-logs">Download</button>
                    </div>
                </div>
                <div class="logs" id="drawer-logs"></div>
            </section>
            <section class="drawer-panel" id="drawer-panel-pending"></section>
        </div>
    </aside>

    <div class="modal-backdrop" id="password-modal">
        <div class="modal">
            <h3 id="password-modal-title">Enter sudo password</h3>
            <p class="subtle" id="password-modal-message"></p>
            <input type="password" id="password-modal-input" placeholder="Password">
            <div class="modal-actions">
                <button class="btn-ghost inline-btn" id="password-modal-cancel">Cancel</button>
                <button class="btn-success inline-btn" id="password-modal-submit">Submit</button>
            </div>
        </div>
    </div>

    <script>
        const LOG_BOTTOM_THRESHOLD = 20;
        let sortKey = "name";
        let sortDir = "asc";
        let allServers = [];
        let page = 1;
        let selectedServers = new Set();
        let hoveredName = null;
        let fetchInFlight = false;
        let fetchQueued = false;
        let queuedForceRender = false;
        let drawerOpen = false;
        let drawerServerName = "";
        let drawerTab = "logs";
        let drawerLogFollow = true;
        let drawerLogScrollTop = 0;
        let passwordResolve = null;
        let passwordReject = null;
        let suppressSortClickUntil = 0;
        const columnResizeStorageKey = "simplelinuxupdater.statusTableColWidths.v5";
        const defaultColumnWidths = Object.freeze({
            name: 220,
            status: 120,
            actions: 500
        });
        const minColumnWidths = Object.freeze({
            name: 140,
            status: 96,
            actions: 420
        });
        const maxColumnWidths = Object.freeze({
            name: 520,
            status: 180,
            actions: 760
        });
        const allowedStatuses = new Set([
            "idle", "updating", "pending_approval", "approved", "cancelled",
            "upgrading", "autoremove", "sudoers", "done", "error"
        ]);

        function escapeHtml(value) {
            return String(value ?? "")
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function escapeJsSingleQuoted(value) {
            return String(value ?? "")
                .replace(/\\/g, "\\\\")
                .replace(/'/g, "\\'")
                .replace(/\r/g, "\\r")
                .replace(/\n/g, "\\n")
                .replace(/\u2028/g, "\\u2028")
                .replace(/\u2029/g, "\\u2029");
        }

        function safeStatusClass(value) {
            const normalized = String(value ?? "").toLowerCase();
            return allowedStatuses.has(normalized) ? normalized : "error";
        }

        function isNearBottom(el) {
            return (el.scrollHeight - el.scrollTop - el.clientHeight) <= LOG_BOTTOM_THRESHOLD;
        }

        function classifyLogLine(line) {
            const lower = line.toLowerCase();
            const bracketState = String(line || "").match(/\[(PASS|WARN|FAIL)\]/i);
            if (bracketState) {
                const state = bracketState[1].toUpperCase();
                if (state === "FAIL") return "error";
                if (state === "WARN") return "warning";
                if (state === "PASS") return "success";
            }
            if (/(error|failed|fatal|denied|refused|panic|timeout|timed out)/.test(lower)) return "error";
            if (/(warn|warning|retry|deprecated)/.test(lower)) return "warning";
            if (/(done|completed|success|approved|enabled|disabled|cancelled)/.test(lower)) return "success";
            if (/(starting|running|connecting|upgradable|upgrade|apt|ssh|info)/.test(lower)) return "info";
            return "";
        }

        function formatLogsHtml(logText) {
            const text = String(logText || "");
            if (!text) {
                return `<div class="log-line log-line-info">No logs yet.</div>`;
            }
            const lines = text.split(/\r?\n/);
            return lines.map(line => {
                const klass = classifyLogLine(line);
                const classAttr = klass ? ` log-line-${klass}` : "";
                const printable = line.length ? line : " ";
                return `<div class="log-line${classAttr}">${escapeHtml(printable)}</div>`;
            }).join("");
        }

        function pendingStateBadge(state) {
            const normalized = String(state || "").toLowerCase();
            if (normalized === "pending") return `<span class="pending-badge">Scanning CVEs...</span>`;
            if (normalized === "unavailable") return `<span class="pending-badge">CVE lookup unavailable</span>`;
            if (normalized === "skipped") return `<span class="pending-badge">CVE lookup skipped</span>`;
            if (normalized === "ready") return "";
            return `<span class="pending-badge">Unknown state</span>`;
        }

        function hasPendingUpdates(server) {
            if (!server || server.status !== "pending_approval") return false;
            return Array.isArray(server.pending_updates) && server.pending_updates.length > 0;
        }

        function getPendingApprovalCounts(server) {
            const pendingUpdates = Array.isArray(server?.pending_updates) ? server.pending_updates : [];
            const totalFromPending = pendingUpdates.length;
            const securityFromPending = pendingUpdates.filter(update => !!update?.security).length;
            const upgradableFallback = Array.isArray(server?.upgradable) ? server.upgradable.length : 0;
            const total = totalFromPending > 0 ? totalFromPending : upgradableFallback;
            return {
                total,
                security: totalFromPending > 0 ? securityFromPending : null
            };
        }

        function renderPendingUpdatesHtml(server, includeHeading = true) {
            const updates = Array.isArray(server?.pending_updates) ? server.pending_updates : [];
            if (server?.status !== "pending_approval" || updates.length === 0) {
                return `<p class="drawer-empty">No pending update details for this server.</p>`;
            }

            const hasPending = updates.some(update => String(update.cve_state || "").toLowerCase() === "pending");
            const securityCount = updates.filter(update => !!update.security).length;
            const stateCounts = updates.reduce((acc, update) => {
                const state = String(update.cve_state || "").toLowerCase();
                acc[state] = (acc[state] || 0) + 1;
                return acc;
            }, {});

            const rows = updates.map(update => {
                const pkg = escapeHtml(update.package || "unknown");
                const currentVersion = escapeHtml(update.current_version || "?");
                const candidateVersion = escapeHtml(update.candidate_version || "?");
                const source = escapeHtml(update.source || "");
                const state = String(update.cve_state || "").toLowerCase();
                const cves = Array.isArray(update.cves) ? update.cves : [];

                const badges = [];
                if (update.security) badges.push(`<span class="pending-badge pending-badge-security">Security</span>`);
                if (state === "ready") {
                    if (cves.length > 0) {
                        badges.push(`<span class="pending-badge pending-badge-cve">${cves.length} CVE${cves.length > 1 ? "s" : ""}</span>`);
                        cves.slice(0, 3).forEach(cve => badges.push(`<span class="pending-badge">${escapeHtml(cve)}</span>`));
                    } else {
                        badges.push(`<span class="pending-badge">No CVE found</span>`);
                    }
                } else {
                    badges.push(pendingStateBadge(state));
                }

                return `
                    <tr>
                        <td>
                            <div>${pkg}</div>
                            ${source ? `<div class="subtle">${source}</div>` : ""}
                        </td>
                        <td>${currentVersion} &rarr; ${candidateVersion}</td>
                        <td><div class="pending-badges">${badges.join("")}</div></td>
                    </tr>
                `;
            }).join("");

            return `
                <div class="pending-updates">
                    ${includeHeading ? "<h4>Pending updates (security first)</h4>" : ""}
                    <div class="pending-summary">
                        <span class="pending-badge">${updates.length} package${updates.length > 1 ? "s" : ""}</span>
                        <span class="pending-badge pending-badge-security">${securityCount} security</span>
                        <span class="pending-badge">${stateCounts.ready || 0} ready</span>
                        <span class="pending-badge">${stateCounts.pending || 0} scanning</span>
                        <span class="pending-badge">${stateCounts.unavailable || 0} unavailable</span>
                        <span class="pending-badge">${stateCounts.skipped || 0} skipped</span>
                    </div>
                    ${hasPending ? `<p class="pending-note">CVE scan in progress; list will update automatically.</p>` : ""}
                    <div class="table-wrap">
                        <table class="pending-table">
                            <thead>
                                <tr>
                                    <th>Package</th>
                                    <th>Version</th>
                                    <th>Risk</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function saveWindowScroll() {
            return { x: window.scrollX, y: window.scrollY };
        }

        function restoreWindowScroll(pos) {
            if (!pos) return;
            window.scrollTo(pos.x, pos.y);
        }

        function getTableColByKey(key) {
            return document.querySelector(`#servers-table col[data-col-key="${key}"]`);
        }

        function loadColumnWidths() {
            try {
                const raw = localStorage.getItem(columnResizeStorageKey);
                if (!raw) return {};
                const parsed = JSON.parse(raw);
                return parsed && typeof parsed === "object" ? parsed : {};
            } catch (_) {
                return {};
            }
        }

        function saveColumnWidths(widths) {
            try {
                localStorage.setItem(columnResizeStorageKey, JSON.stringify(widths));
            } catch (_) {
                // Ignore storage failures (private mode, quota, etc.)
            }
        }

        function applyColumnWidths(widths) {
            Object.keys(defaultColumnWidths).forEach((key) => {
                const col = getTableColByKey(key);
                if (!col) return;
                const configured = Number(widths[key]);
                const minWidth = minColumnWidths[key] || 100;
                const maxWidth = maxColumnWidths[key] || 9999;
                const fallback = defaultColumnWidths[key];
                const boundedFallback = Math.min(maxWidth, Math.max(minWidth, fallback));
                const nextWidth = Number.isFinite(configured)
                    ? Math.min(maxWidth, Math.max(minWidth, configured))
                    : boundedFallback;
                col.style.width = `${Math.round(nextWidth)}px`;
            });
        }

        function initColumnResizing() {
            const savedWidths = loadColumnWidths();
            applyColumnWidths(savedWidths);

            document.querySelectorAll('#servers-table .col-resize-handle').forEach((handle) => {
                if (handle.dataset.bound === "1") return;
                handle.dataset.bound = "1";

                handle.addEventListener('pointerdown', (event) => {
                    event.preventDefault();
                    event.stopPropagation();

                    const colKey = handle.dataset.colKey || "";
                    const col = getTableColByKey(colKey);
                    const th = handle.closest('th');
                    if (!col || !th) return;

                    const minWidth = minColumnWidths[colKey] || 100;
                    const maxWidth = maxColumnWidths[colKey] || 9999;
                    const startX = event.clientX;
                    const startWidth = Math.max(minWidth, Math.round(col.getBoundingClientRect().width));

                    const onPointerMove = (moveEvent) => {
                        const delta = moveEvent.clientX - startX;
                        const nextWidth = Math.min(maxWidth, Math.max(minWidth, startWidth + delta));
                        col.style.width = `${Math.round(nextWidth)}px`;
                    };

                    const finishResize = (endEvent, canceled) => {
                        window.removeEventListener('pointermove', onPointerMove);
                        window.removeEventListener('pointerup', onPointerUp);
                        window.removeEventListener('pointercancel', onPointerCancel);
                        document.body.classList.remove('col-resizing');
                        th.classList.remove('resizing');

                        if (canceled) {
                            col.style.width = `${Math.round(startWidth)}px`;
                        } else {
                            const finalWidth = Math.min(maxWidth, Math.max(minWidth, Math.round(col.getBoundingClientRect().width)));
                            const nextWidths = loadColumnWidths();
                            nextWidths[colKey] = finalWidth;
                            saveColumnWidths(nextWidths);
                            suppressSortClickUntil = Date.now() + 250;
                        }

                        if (handle.releasePointerCapture && endEvent.pointerId !== undefined) {
                            try {
                                handle.releasePointerCapture(endEvent.pointerId);
                            } catch (_) {
                                // Ignore pointer release issues.
                            }
                        }
                    };

                    const onPointerUp = (endEvent) => finishResize(endEvent, false);
                    const onPointerCancel = (endEvent) => finishResize(endEvent, true);

                    document.body.classList.add('col-resizing');
                    th.classList.add('resizing');
                    if (handle.setPointerCapture && event.pointerId !== undefined) {
                        try {
                            handle.setPointerCapture(event.pointerId);
                        } catch (_) {
                            // Ignore pointer capture issues.
                        }
                    }

                    window.addEventListener('pointermove', onPointerMove);
                    window.addEventListener('pointerup', onPointerUp);
                    window.addEventListener('pointercancel', onPointerCancel);
                });
            });
        }

        async function fetchServers(forceRender = false) {
            if (fetchInFlight) {
                fetchQueued = true;
                queuedForceRender = queuedForceRender || forceRender;
                return;
            }
            fetchInFlight = true;
            const pageScroll = saveWindowScroll();
            try {
                let parsedServers;
                try {
                    const response = await fetch('/api/servers');
                    if (!response.ok) {
                        throw new Error(`Failed to fetch servers: HTTP ${response.status}`);
                    }
                    parsedServers = await response.json();
                    if (!Array.isArray(parsedServers)) {
                        throw new Error('Invalid servers payload: expected an array');
                    }
                } catch (err) {
                    console.error('Unable to refresh servers list:', err);
                    return;
                }
                allServers = parsedServers;
                renderTable();
                renderDrawer();
                requestAnimationFrame(() => restoreWindowScroll(pageScroll));
            } finally {
                fetchInFlight = false;
                if (fetchQueued) {
                    fetchQueued = false;
                    const nextRender = queuedForceRender;
                    queuedForceRender = false;
                    fetchServers(nextRender);
                }
            }
        }

        function sortServers(servers) {
            const dir = sortDir === "asc" ? 1 : -1;
            return servers.slice().sort((a, b) => {
                const aVal = (a[sortKey] || "").toString().toLowerCase();
                const bVal = (b[sortKey] || "").toString().toLowerCase();
                if (aVal < bVal) return -1 * dir;
                if (aVal > bVal) return 1 * dir;
                return 0;
            });
        }

        function applyFilters(servers) {
            const search = document.getElementById('search').value.trim().toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const authFilter = document.getElementById('auth-filter').value;
            return servers.filter(server => {
                if (statusFilter && server.status !== statusFilter) return false;
                if (authFilter === "password" && !server.has_password) return false;
                if (authFilter === "key" && !server.has_key) return false;
                if (!search) return true;
                const haystack = [
                    server.name,
                    server.host,
                    server.port ? server.port.toString() : "",
                    server.user,
                    (server.tags || []).join(" ")
                ].join(" ").toLowerCase();
                return haystack.includes(search);
            });
        }

        function paginate(servers) {
            const size = parseInt(document.getElementById('page-size').value, 10);
            const totalPages = Math.max(1, Math.ceil(servers.length / size));
            page = Math.min(page, totalPages);
            const start = (page - 1) * size;
            const end = start + size;
            document.getElementById('page-info').textContent = `Page ${page} of ${totalPages} (${servers.length} hosts)`;
            return servers.slice(start, end);
        }

        function groupServers(servers) {
            const groupBy = document.getElementById('group-by').value;
            if (!groupBy) return [{ key: "", items: servers }];
            const groups = new Map();
            if (groupBy === "status") {
                servers.forEach(server => {
                    const key = server.status || "unknown";
                    if (!groups.has(key)) groups.set(key, []);
                    groups.get(key).push(server);
                });
            } else if (groupBy === "tag") {
                servers.forEach(server => {
                    const tags = server.tags && server.tags.length ? server.tags : ["untagged"];
                    tags.forEach(tag => {
                        if (!groups.has(tag)) groups.set(tag, []);
                        groups.get(tag).push(server);
                    });
                });
            }
            return Array.from(groups.entries()).map(([key, items]) => ({ key, items }));
        }

        function openDrawer(name, tab = "logs") {
            const nextTab = tab === "pending" ? "pending" : "logs";
            if (drawerServerName !== name) {
                drawerLogFollow = true;
                drawerLogScrollTop = 0;
            }
            drawerOpen = true;
            drawerServerName = name;
            drawerTab = nextTab;
            renderDrawer();
        }

        function closeDrawer() {
            drawerOpen = false;
            const drawer = document.getElementById('status-drawer');
            const backdrop = document.getElementById('status-drawer-backdrop');
            drawer.classList.remove('open');
            backdrop.classList.remove('open');
            drawer.setAttribute('aria-hidden', 'true');
        }

        function setDrawerTab(tab) {
            if (tab !== "logs" && tab !== "pending") return;
            drawerTab = tab;
            renderDrawer();
        }

        function renderDrawer() {
            const drawer = document.getElementById('status-drawer');
            const backdrop = document.getElementById('status-drawer-backdrop');
            const title = document.getElementById('status-drawer-title');
            const statusContainer = document.getElementById('status-drawer-status');
            const logsTabBtn = document.getElementById('drawer-tab-logs');
            const pendingTabBtn = document.getElementById('drawer-tab-pending');
            const logsPanel = document.getElementById('drawer-panel-logs');
            const pendingPanel = document.getElementById('drawer-panel-pending');
            const logsHint = document.getElementById('drawer-logs-hint');
            const logsEl = document.getElementById('drawer-logs');
            const approvalActions = document.getElementById('status-drawer-approval-actions');
            const drawerApproveAllBtn = document.getElementById('drawer-approve-all');
            const drawerApproveSecurityBtn = document.getElementById('drawer-approve-security');

            if (!drawerOpen) {
                drawer.classList.remove('open');
                backdrop.classList.remove('open');
                drawer.setAttribute('aria-hidden', 'true');
                return;
            }

            const server = getServerByName(drawerServerName);
            if (!server) {
                closeDrawer();
                return;
            }

            const safeStatus = safeStatusClass(server.status);
            const safeStatusText = escapeHtml(server.status || "unknown");
            const isPendingApproval = server.status === "pending_approval";
            const hasPending = hasPendingUpdates(server);
            const approvalCounts = getPendingApprovalCounts(server);
            const securityApprovalLabel = approvalCounts.security === null
                ? "Approve security only (unknown)"
                : `Approve security only (${approvalCounts.security})`;
            if (drawerTab === "pending" && !hasPending) {
                drawerTab = "logs";
            }

            title.textContent = server.name || "Server details";
            statusContainer.innerHTML = `<span class="status-pill status-${safeStatus}">${safeStatusText}</span>`;
            approvalActions.classList.toggle('hidden', !isPendingApproval);
            drawerApproveAllBtn.textContent = `Approve all (${approvalCounts.total})`;
            drawerApproveSecurityBtn.textContent = securityApprovalLabel;

            pendingTabBtn.disabled = !hasPending;
            pendingTabBtn.classList.toggle('active', drawerTab === "pending");
            logsTabBtn.classList.toggle('active', drawerTab === "logs");

            logsPanel.classList.toggle('active', drawerTab === "logs");
            pendingPanel.classList.toggle('active', drawerTab === "pending");

            if (drawerTab === "logs") {
                logsEl.innerHTML = formatLogsHtml(server.logs || "");
                if (drawerLogFollow) {
                    logsEl.scrollTop = logsEl.scrollHeight;
                } else {
                    logsEl.scrollTop = drawerLogScrollTop;
                }
                logsHint.textContent = drawerLogFollow ? "Live auto-scroll" : "Auto-scroll paused";
            }

            if (drawerTab === "pending") {
                pendingPanel.innerHTML = renderPendingUpdatesHtml(server, true);
            } else {
                pendingPanel.innerHTML = "";
            }

            drawer.classList.add('open');
            backdrop.classList.add('open');
            drawer.setAttribute('aria-hidden', 'false');
        }

        function renderTable() {
            const tbody = document.querySelector('#servers-table tbody');
            tbody.innerHTML = '';
            let servers = applyFilters(allServers);
            servers = sortServers(servers);
            const paged = paginate(servers);
            const groups = groupServers(paged);
            groups.forEach(group => {
                if (group.key) {
                    const groupRow = document.createElement('tr');
                    groupRow.className = 'group-row';
                    groupRow.innerHTML = `<td colspan="4">${escapeHtml(group.key)}</td>`;
                    tbody.appendChild(groupRow);
                }
                group.items.forEach(server => {
                    const row = document.createElement('tr');
                    row.dataset.name = server.name;
                    if (hoveredName === server.name) {
                        row.classList.add('row-hover');
                    }
                    const isBusy = server.status === 'updating' || server.status === 'upgrading' || server.status === 'autoremove' || server.status === 'sudoers';
                    const safeNameJs = escapeJsSingleQuoted(server.name);
                    const safeNameOnclickAttr = escapeHtml(safeNameJs);
                    const safeNameHtml = escapeHtml(server.name);
                    const safeStatusText = escapeHtml(server.status || "unknown");
                    const safeStatus = safeStatusClass(server.status);
                    const safeDataName = escapeHtml(server.name);
                    const approvalCounts = getPendingApprovalCounts(server);
                    const securityApprovalLabel = approvalCounts.security === null
                        ? "Approve security only (unknown)"
                        : `Approve security only (${approvalCounts.security})`;
                    const actionButtons = server.status === 'pending_approval'
                        ? `
                            <div class="actions-grid">
                                <button onclick="approveAllUpdates('${safeNameOnclickAttr}')" title="Approve all updates">Approve all (${approvalCounts.total})</button>
                                <button class="btn-security" onclick="approveSecurityUpdates('${safeNameOnclickAttr}')" title="Approve only security updates">${securityApprovalLabel}</button>
                                <button class="btn-ghost" onclick="openDrawer('${safeNameOnclickAttr}', 'logs')">Logs</button>
                                <button class="btn-danger" onclick="cancelUpgrade('${safeNameOnclickAttr}')">Cancel</button>
                                <button class="btn-ghost" onclick="openDrawer('${safeNameOnclickAttr}', 'pending')">Pending updates</button>
                            </div>
                          `
                        : `
                            <div class="actions-grid">
                                <button onclick="updateServer('${safeNameOnclickAttr}')" ${isBusy ? 'disabled' : ''}>Update</button>
                                <button onclick="runAutoremove('${safeNameOnclickAttr}')" ${isBusy ? 'disabled' : ''} title="Run apt autoremove">Autoremove</button>
                                <button class="btn-ghost" onclick="openDrawer('${safeNameOnclickAttr}', 'logs')">Logs</button>
                                <button onclick="enablePasswordlessApt('${safeNameOnclickAttr}')" ${isBusy ? 'disabled' : ''} title="Enable passwordless apt">Enable apt</button>
                                <button onclick="disablePasswordlessApt('${safeNameOnclickAttr}')" ${isBusy ? 'disabled' : ''} title="Disable passwordless apt">Disable apt</button>
                            </div>
                          `;
                    row.innerHTML = `
                        <td class="select-col"><input type="checkbox" class="row-select" data-name="${safeDataName}" ${selectedServers.has(server.name) ? "checked" : ""}></td>
                        <td class="name-cell" title="${safeNameHtml}">${safeNameHtml}</td>
                        <td class="status-col"><span class="status-pill status-${safeStatus}">${safeStatusText}</span></td>
                        <td class="actions-col">${actionButtons}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
            applyHoverClass();
            tbody.querySelectorAll('.row-select').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const name = e.target.dataset.name;
                    if (e.target.checked) {
                        selectedServers.add(name);
                    } else {
                        selectedServers.delete(name);
                    }
                });
            });
            document.getElementById('select-all').checked = paged.length > 0 && paged.every(s => selectedServers.has(s.name));
        }

        function getServerByName(name) {
            return allServers.find(server => server.name === name);
        }

        async function copyLogs(name = drawerServerName) {
            const server = getServerByName(name);
            const logs = String(server?.logs || "");
            try {
                await navigator.clipboard.writeText(logs);
            } catch (_) {
                const tmp = document.createElement('textarea');
                tmp.value = logs;
                document.body.appendChild(tmp);
                tmp.select();
                document.execCommand('copy');
                tmp.remove();
            }
        }

        function downloadLogs(name = drawerServerName) {
            const server = getServerByName(name);
            const logs = String(server?.logs || "");
            const blob = new Blob([logs], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const safeName = String(name || "server").replace(/[^a-zA-Z0-9._-]/g, '_');
            link.href = url;
            link.download = `${safeName}-logs.txt`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
        }

        function applyHoverClass() {
            const tbody = document.querySelector('#servers-table tbody');
            tbody.querySelectorAll('tr').forEach(tr => tr.classList.remove('row-hover'));
            if (!hoveredName) return;
            const row = tbody.querySelector(`tr[data-name="${CSS.escape(hoveredName)}"]`);
            if (row) {
                row.classList.add('row-hover');
            }
        }

        const tbodyHover = document.querySelector('#servers-table tbody');
        tbodyHover.addEventListener('mouseover', (e) => {
            const row = e.target.closest('tr[data-name]');
            if (!row) return;
            hoveredName = row.dataset.name || null;
            applyHoverClass();
        });
        tbodyHover.addEventListener('mouseleave', () => {
            hoveredName = null;
            applyHoverClass();
        });

        document.querySelectorAll('#servers-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                if (Date.now() < suppressSortClickUntil) {
                    return;
                }
                const key = th.dataset.sortKey;
                if (sortKey === key) {
                    sortDir = sortDir === "asc" ? "desc" : "asc";
                } else {
                    sortKey = key;
                    sortDir = "asc";
                }
                renderTable();
            });
        });

        document.getElementById('search').addEventListener('input', () => { page = 1; renderTable(); });
        document.getElementById('status-filter').addEventListener('change', () => { page = 1; renderTable(); });
        document.getElementById('auth-filter').addEventListener('change', () => { page = 1; renderTable(); });
        document.getElementById('group-by').addEventListener('change', () => { page = 1; renderTable(); });
        document.getElementById('page-size').addEventListener('change', () => { page = 1; renderTable(); });

        document.getElementById('prev-page').addEventListener('click', () => {
            page = Math.max(1, page - 1);
            renderTable();
        });
        document.getElementById('next-page').addEventListener('click', () => {
            page += 1;
            renderTable();
        });

        document.getElementById('select-all').addEventListener('change', (e) => {
            const checked = e.target.checked;
            const filtered = sortServers(applyFilters(allServers));
            const paged = paginate(filtered);
            paged.forEach(server => {
                if (checked) {
                    selectedServers.add(server.name);
                } else {
                    selectedServers.delete(server.name);
                }
            });
            renderTable();
        });

        document.getElementById('bulk-update').addEventListener('click', async () => {
            const names = Array.from(selectedServers);
            await Promise.all(names.map(name => fetch(`/api/update/${encodeURIComponent(name)}`, { method: 'POST' })));
            fetchServers();
        });
        document.getElementById('bulk-approve').addEventListener('click', async () => {
            const names = Array.from(selectedServers);
            await Promise.all(names.map(name => fetch(`/api/approve/${encodeURIComponent(name)}`, { method: 'POST' })));
            fetchServers();
        });
        document.getElementById('bulk-cancel').addEventListener('click', async () => {
            const names = Array.from(selectedServers);
            await Promise.all(names.map(name => fetch(`/api/cancel/${encodeURIComponent(name)}`, { method: 'POST' })));
            fetchServers();
        });
        document.getElementById('bulk-autoremove').addEventListener('click', async () => {
            const names = Array.from(selectedServers);
            await Promise.all(names.map(name => fetch(`/api/autoremove/${encodeURIComponent(name)}`, { method: 'POST' })));
            fetchServers();
        });

        async function updateServer(name) {
            await fetch(`/api/update/${encodeURIComponent(name)}`, { method: 'POST' });
            fetchServers();
        }

        async function runAutoremove(name) {
            await fetch(`/api/autoremove/${encodeURIComponent(name)}`, { method: 'POST' });
            fetchServers();
        }

        async function enablePasswordlessApt(name) {
            const password = await promptPassword(`Enter sudo password for ${name}`);
            if (!password) return;
            await fetch(`/api/sudoers/${encodeURIComponent(name)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            fetchServers();
        }

        async function disablePasswordlessApt(name) {
            const password = await promptPassword(`Enter sudo password to disable for ${name}`);
            if (!password) return;
            await fetch(`/api/sudoers/disable/${encodeURIComponent(name)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            fetchServers();
        }

        function promptPassword(message) {
            const backdrop = document.getElementById('password-modal');
            const input = document.getElementById('password-modal-input');
            const msg = document.getElementById('password-modal-message');
            msg.textContent = message;
            input.value = '';
            backdrop.classList.add('active');
            input.focus();
            return new Promise((resolve, reject) => {
                passwordResolve = resolve;
                passwordReject = reject;
            });
        }

        function closePasswordModal() {
            const backdrop = document.getElementById('password-modal');
            backdrop.classList.remove('active');
        }

        document.getElementById('password-modal-cancel').addEventListener('click', () => {
            if (passwordResolve) {
                passwordResolve('');
            }
            closePasswordModal();
        });

        document.getElementById('password-modal-submit').addEventListener('click', () => {
            const input = document.getElementById('password-modal-input');
            if (passwordResolve) {
                passwordResolve(input.value);
            }
            closePasswordModal();
        });

        document.getElementById('password-modal-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('password-modal-submit').click();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                document.getElementById('password-modal-cancel').click();
            }
        });

        document.getElementById('status-drawer-close').addEventListener('click', closeDrawer);
        document.getElementById('status-drawer-backdrop').addEventListener('click', closeDrawer);
        document.getElementById('drawer-tab-logs').addEventListener('click', () => setDrawerTab('logs'));
        document.getElementById('drawer-tab-pending').addEventListener('click', () => setDrawerTab('pending'));
        document.getElementById('drawer-copy-logs').addEventListener('click', () => copyLogs());
        document.getElementById('drawer-download-logs').addEventListener('click', () => downloadLogs());
        document.getElementById('drawer-approve-all').addEventListener('click', () => {
            if (!drawerServerName) return;
            approveAllUpdates(drawerServerName);
        });
        document.getElementById('drawer-approve-security').addEventListener('click', () => {
            if (!drawerServerName) return;
            approveSecurityUpdates(drawerServerName);
        });

        const drawerLogsElement = document.getElementById('drawer-logs');
        drawerLogsElement.addEventListener('scroll', () => {
            drawerLogScrollTop = drawerLogsElement.scrollTop;
            drawerLogFollow = isNearBottom(drawerLogsElement);
            document.getElementById('drawer-logs-hint').textContent = drawerLogFollow ? "Live auto-scroll" : "Auto-scroll paused";
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && drawerOpen) {
                e.preventDefault();
                closeDrawer();
            }
        });

        async function approveAllUpdates(name) {
            await fetch(`/api/approve/${encodeURIComponent(name)}`, { method: 'POST' });
            fetchServers();
        }

        async function approveSecurityUpdates(name) {
            await fetch(`/api/approve-security/${encodeURIComponent(name)}`, { method: 'POST' });
            fetchServers();
        }

        async function cancelUpgrade(name) {
            await fetch(`/api/cancel/${encodeURIComponent(name)}`, { method: 'POST' });
            fetchServers();
        }

        initColumnResizing();
        setInterval(fetchServers, 2000);
        fetchServers();
    </script>
</body>
</html>
