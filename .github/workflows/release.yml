name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: read
  packages: write

jobs:
  release-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.x"
          cache: true

      - name: Run tests
        run: |
          go test -count=1 ./...
          go test -race -count=1 ./...

      - name: Verify release metadata
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG"
          echo "$TAG" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+$'
          grep -q "^Version: $TAG$" README.md
          grep -q "Version $TAG" templates/index.html
          test -f CHANGELOG.md
          grep -q "^## \[$TAG\]" CHANGELOG.md

  publish-release:
    needs: release-gate
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.x"
          cache: true

      - name: Build release archives
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          APP="SimpleLinuxUpdater_${VERSION}"
          mkdir -p dist

          for TARGET in "linux amd64" "linux arm64" "darwin amd64" "darwin arm64" "windows amd64"; do
            GOOS="${TARGET%% *}"
            GOARCH="${TARGET##* }"
            EXT=""
            if [ "$GOOS" = "windows" ]; then
              EXT=".exe"
            fi

            BIN="webserver_${GOOS}_${GOARCH}${EXT}"
            PKG_DIR="dist/${APP}_${GOOS}_${GOARCH}"
            PKG_ROOT="${PKG_DIR}/${APP}"

            CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" go build -trimpath -ldflags="-s -w" -o "dist/${BIN}" webserver.go

            mkdir -p "$PKG_ROOT"
            cp "dist/${BIN}" "${PKG_ROOT}/webserver${EXT}"
            cp -r templates static "$PKG_ROOT/"
            cp README.md LICENSE .env-template "$PKG_ROOT/"

            if [ "$GOOS" = "windows" ]; then
              (
                cd "$PKG_DIR"
                zip -qr "../${APP}_${GOOS}_${GOARCH}.zip" "$APP"
              )
            else
              tar -C "$PKG_DIR" -czf "dist/${APP}_${GOOS}_${GOARCH}.tar.gz" "$APP"
            fi
            rm -rf "$PKG_DIR" "dist/${BIN}"
          done

          (
            cd dist
            sha256sum *.tar.gz *.zip > checksums.txt
          )

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt

  publish-docker:
    needs: [release-gate, publish-release]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute image name
        id: image
        run: |
          set -euo pipefail
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          REPO_LC="$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')"
          echo "name=ghcr.io/${OWNER_LC}/${REPO_LC}" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
